var q = require('q');
var MongoClient = require('mongodb').MongoClient;
var feathersMongoDBs = require('./feathers-mongodb-databases');
var feathersMongoColls = require('./feathers-mongodb-collections');
var feathersMongo = require('feathers-mongodb');

/**
 * Amity-MongoDB connects to a MongoDB server and uses several Feathers
 * service types to manage either the entire server (multiple databases)
 * or a single database.
 *
 * The modules used are as follows:
 * 	 amity-mongodb - This module. In charge of the overall MongoDB server.
 *   feathers-mongodb-databases   - to manage databases on the server
 *   feathers-mongodb-collections - to manage collections in those databases
 *   feathers-mongodb             - to manage documents in each collection
 *   feathers-mongodb-users       - to manage user permissions
 *
 * Each instance will manage up to one full server. (It might manage a partial server.)
 *
 * @param  {Object} config - Can be either the hostname of the server or the
 *                         server connection details. The app will
 *                         connect to this MongoDB server with the supplied
 *                         credentials.
 * @return {Object}  An Adapter to be registered on the Amity app.
 */
module.exports = function(config) {

	var amityMongo = {
		type:'mongodb',
		scope:'server',
		db:null,
		namespace:'',
		getStatus: function(callback){
			var adminDB = this.db.admin();
			adminDB.serverStatus(function(err, status){
				callback(status);
			});
		},
		amity_dbManager:[],
		amity_collManager:[],
		amity_collections:[],
		amity_users:[]
	};

	var deferred = q.defer();

	// If a connection string was passed.
	if (typeof config == 'string') {

		// Get a list of the servers.
		MongoClient.connect(config, function(err, db) {
		  console.log("Amity-MongoDB connected to server " + amityMongo.namespace);

			// Set the adapter's namespace attribute, which is the hostname with port.
			amityMongo.namespace = db.serverConfig.host + ':' + db.serverConfig.port;

			// Access to the db after it has been set up.
			amityMongo.db = db;

		  adminDB = db.admin();

		  // Add the db manager to the list of amity_ services.
		  amityMongo.amity_dbManager.push({'name':'_databases', service:feathersMongoDBs(db)});

		  // Get a list of databases to register collection managers on.
		  adminDB.listDatabases(function(err, dbs){
			  amityMongo.databases = dbs.databases;

			  // Loop through the list of databases...
			  for (var i = dbs.databases.length - 1; i >= 0; i--) {

			  	var currentDB = dbs.databases[i];
			  	// ...and ready a service for managing the collections on the currentDB.
			  	var options = {
			  		name:currentDB.name + '/_collections',
			  		service:feathersMongoColls(db, currentDB.name)
			  	};
			  	amityMongo.amity_collManager.push(options);

					// Use these for the async function to track when it's done.
			  	var index = 0;
			  	var targetIndex = dbs.databases.length  - 1;
			  	var databaseName;

			  	// Get the collections from each database.
			  	var changeDB = db.db(currentDB.name);
			  	changeDB.listCollections().toArray(function(err, collections) {
			  		for (var n = 0; n < collections.length; n++) {
			  	  	// Prep the collection name.
			  	  	var colName = collections[n].name.split('.');
			  	  	var dbName = colName.shift();
			  	  	if (databaseName !== dbName) {
			  	  		databaseName = dbName;
			  	  		index++;
			  	  	}
			  	  	colName = colName.join('.');
			  	  	// console.log(colName);
			  	  	options = {
			  	  		name:dbName + '/' + colName,
			  	  		service:feathersMongo({collection:colName})
			  	  	};
					  	// amityMongo.amity_collections.push(options);

			  	  	// If we're done looping, resolve the deferred.
			  	  	if (n === collections.length - 1 && index === targetIndex) {
			  	  		deferred.resolve(amityMongo);
			  	  	}
			  	  };
			  	});
			  };
		  });
		});

	// If an object was passed...
	// TODO: Make it possible to connect to MongoDB by passing a config object.
	} else if(typeof config == 'object'){
		// ... create a connection string

		// If a custom collection name for servers was given...
		if (config.userCollection) {
			amityMongo.servers = config.serverCollection;
		}

		// If a custom collection name for users was given...
		if (config.userCollection) {
			amityMongo.users = config.userCollection;
		}

	} else {
		console.log('not connecting to anything.');
	}

	// This deferred must resolve with the fully-connected adapter.
	return deferred.promise;
};
